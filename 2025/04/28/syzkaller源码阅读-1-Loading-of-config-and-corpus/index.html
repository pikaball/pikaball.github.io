

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" href="/img/favicon.ico">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="pikaball">
  <meta name="keywords" content="">
  
    <meta name="description" content="在前一篇文章中，我们从文档了解了syzkaller的fuzz结构和使用方法。这一篇我们将正式开始源码阅读，从一切的入口开始。  Entry &amp; Config程序的入口是在syz-manager&#x2F;manager.go.  12345678func main() &#123;	flag.Parse()	if !prog.GitRevisionKnown() &#123;		log.Fatal">
<meta property="og:type" content="article">
<meta property="og:title" content="[syzkaller源码阅读] 1. Loading of config and corpus">
<meta property="og:url" content="https://pikaball.cc/2025/04/28/syzkaller%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-1-Loading-of-config-and-corpus/index.html">
<meta property="og:site_name" content="pikaball&#39;s blog">
<meta property="og:description" content="在前一篇文章中，我们从文档了解了syzkaller的fuzz结构和使用方法。这一篇我们将正式开始源码阅读，从一切的入口开始。  Entry &amp; Config程序的入口是在syz-manager&#x2F;manager.go.  12345678func main() &#123;	flag.Parse()	if !prog.GitRevisionKnown() &#123;		log.Fatal">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-04-28T15:11:54.000Z">
<meta property="article:modified_time" content="2025-04-28T15:45:37.708Z">
<meta property="article:author" content="pikaball">
<meta property="article:tag" content="code review">
<meta property="article:tag" content="go">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>[syzkaller源码阅读] 1. Loading of config and corpus - pikaball&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"pikaball.cc","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":["home"]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":2},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null},"woyaola":null,"cnzz":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>pikaball</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" false
     style="background: url('/img/enkidu2.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.6)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">[syzkaller源码阅读] 1. Loading of config and corpus</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-04-28 23:11" pubdate>
          2025年4月28日
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          2.8k 字
        
      </span>
    

    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">[syzkaller源码阅读] 1. Loading of config and corpus</h1>
            
            
              <div class="markdown-body">
                
                <blockquote>
<p>在前一篇文章中，我们从文档了解了syzkaller的fuzz结构和使用方法。这一篇我们将正式开始源码阅读，从一切的入口开始。</p>
</blockquote>
<h2 id="Entry-Config"><a href="#Entry-Config" class="headerlink" title="Entry &amp; Config"></a>Entry &amp; Config</h2><p>程序的入口是在<code>syz-manager/manager.go</code>. </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	flag.Parse()<br>	<span class="hljs-keyword">if</span> !prog.GitRevisionKnown() &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;bad syz-manager build: build with make, run bin/syz-manager&quot;</span>)<br>	&#125;<br>	log.EnableLogCaching(<span class="hljs-number">1000</span>, <span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">20</span>)<br>	cfg, err := mgrconfig.LoadFile(*flagConfig)<br>    ...<br></code></pre></td></tr></table></figure>

<p>main函数解析参数，设置日志缓存长度，然后把配置文件解析到cfg变量。</p>
<p><code>flag.Parse()</code>会将命令行参数<code>-xxx</code>解析为<code>flagXxx</code>，这里的flagConfig就是在启动syz-manager时传入的配置文件路径。</p>
<p>我们直接跟进<code>pkg/mgrconfig/config.go</code> 看Config结构体定义，反引号包裹的结构体标签描述了此配置项在json格式配置文件中的key，注释中解释了每一个配置项的含义。</p>
<ul>
<li><code>workdir_template</code> : 指定一个目录，这个目录将在每一次创建虚拟机时被拷贝到供该虚拟机使用的临时目录中，这个临时目录的位置可以在qemu参数中使用<code>&#123;&#123;TEMPLATE&#125;&#125;</code> 指代，我们可以看到注释中给出了这样的示例：<code>&quot;qemu_args&quot;: &quot;-fda &#123;&#123;TEMPLATE&#125;&#125;/fd&quot;</code> ，即将模版中的fd挂载到软盘驱动器A</li>
<li><code>kernel_obj</code> : vmlinux所在目录，<strong>如果不是直接在源码树目录中执行的编译 ，还需要指定一下<code>kernel_src</code></strong> ，否则syzkaller会无法生成源码上的coverage报告</li>
</ul>
<p>其余部分不在这里详细列出<del>（懒得写）</del>，我们在后面的审计中碰到再进行描述。</p>
<p>我们接着看这一段：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    ...<br>    <span class="hljs-keyword">var</span> mode *Mode<br>    <span class="hljs-keyword">for</span> _, m := <span class="hljs-keyword">range</span> modes &#123;<br>        <span class="hljs-keyword">if</span> *flagMode == m.Name &#123;<br>            mode = m<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> mode == <span class="hljs-literal">nil</span> &#123;<br>        flag.PrintDefaults()<br>        log.Fatalf(<span class="hljs-string">&quot;unknown mode: %v&quot;</span>, *flagMode)<br>    &#125;<br>    <span class="hljs-keyword">if</span> mode.CheckConfig != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> err := mode.CheckConfig(cfg); err != <span class="hljs-literal">nil</span> &#123;<br>            log.Fatalf(<span class="hljs-string">&quot;%v mode: %v&quot;</span>, mode.Name, err)<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> !mode.UseDashboard &#123;<br>        cfg.DashboardClient = <span class="hljs-string">&quot;&quot;</span><br>        cfg.HubClient = <span class="hljs-string">&quot;&quot;</span><br>    &#125;<br>    ...<br></code></pre></td></tr></table></figure>

<p>其中，modes是一些预定义的Mode结构体：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">modes = []*Mode&#123;<br>	ModeFuzzing,<br>	ModeSmokeTest,<br>	ModeCorpusTriage,<br>	ModeCorpusRun,<br>	ModeRunTests,<br>	ModeIfaceProbe,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们可以在<code>syz-manager</code> 的帮助信息里看到对此的说明：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><br>-mode <span class="hljs-built_in">string</span><br>      mode <span class="hljs-keyword">of</span> operation, one <span class="hljs-keyword">of</span>:<br>       - fuzzing: <span class="hljs-keyword">the</span> default continuous fuzzing mode<br>       - smoke-test: <span class="hljs-built_in">run</span> smoke test <span class="hljs-keyword">for</span> syzkaller+kernel<br>              The test consists <span class="hljs-keyword">of</span> booting VMs <span class="hljs-keyword">and</span> <span class="hljs-built_in">running</span> <span class="hljs-keyword">some</span> simple test programs<br>              <span class="hljs-keyword">to</span> ensure <span class="hljs-keyword">that</span> fuzzing can proceed <span class="hljs-keyword">in</span> general. After completing <span class="hljs-keyword">the</span> test<br>              <span class="hljs-keyword">the</span> process exits <span class="hljs-keyword">and</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">exit</span> status indicates success/failure.<br>              If <span class="hljs-keyword">the</span> kernel oopses during testing, <span class="hljs-keyword">the</span> report <span class="hljs-keyword">is</span> saved <span class="hljs-keyword">to</span> workdir/report.json.<br>       - corpus-triage: triage corpus <span class="hljs-keyword">and</span> <span class="hljs-keyword">exit</span><br>              This <span class="hljs-keyword">is</span> useful mostly <span class="hljs-keyword">for</span> benchmarking <span class="hljs-keyword">with</span> testbed.<br>       - corpus-<span class="hljs-built_in">run</span>: continuously <span class="hljs-built_in">run</span> <span class="hljs-keyword">the</span> corpus programs<br>       - <span class="hljs-built_in">run</span>-tests: <span class="hljs-built_in">run</span> unit tests<br>              Run sys/os/test/* tests <span class="hljs-keyword">in</span> various modes <span class="hljs-keyword">and</span> print results.<br>       - iface-probe: <span class="hljs-built_in">run</span> dynamic part <span class="hljs-keyword">of</span> kernel interface auto-extraction<br>              When <span class="hljs-keyword">the</span> probe <span class="hljs-keyword">is</span> finished, manager writes <span class="hljs-keyword">the</span> <span class="hljs-literal">result</span> <span class="hljs-keyword">to</span> workdir/interfaces.json <span class="hljs-built_in">file</span> <span class="hljs-keyword">and</span> exits.<br>       (default <span class="hljs-string">&quot;fuzzing&quot;</span>)<br><br></code></pre></td></tr></table></figure>

<p>不指定mode就默认是fuzzing模式，也就是正常的模糊测试。</p>
<ul>
<li>smoke-test：执行一些简单样例检测syzkaller和内核配置是否正常</li>
<li>corpus-traige：语料库筛选</li>
<li>corpus-run：持续运行语料库中的程序</li>
<li>run-tests：运行 <code>sys/os/test/*</code> 目录下的测试</li>
<li>iface-probe：动态提取内核接口并写入 <code>workdir/interfaces.json</code></li>
</ul>
<p>寻找<code>CheckConfig</code> ，发现只有<code>ModeIfaceProbe</code> 实现了这个函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go">CheckConfig: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(cfg *mgrconfig.Config)</span></span> <span class="hljs-type">error</span> &#123;<br>			<span class="hljs-keyword">if</span> cfg.Snapshot &#123;<br>				<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;snapshot mode is not supported&quot;</span>)<br>			&#125;<br>			<span class="hljs-keyword">if</span> cfg.Sandbox != <span class="hljs-string">&quot;none&quot;</span> &#123;<br>				<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;sandbox \&quot;%v\&quot; is not supported (only \&quot;none\&quot;)&quot;</span>, cfg.Sandbox)<br>			&#125;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>		&#125;<br></code></pre></td></tr></table></figure>

<p>也就是这个模式的要求是config中不能指定Snapshot为True（snapshot选项允许vm从上一次运行的快照中热启动），且sandbox需要为none。</p>
<p>检查完config和mode之后，进入<code>RunManager(mode, cfg)</code> ，这个函数用来初始化Manager并进入fuzz循环，它主要做了这么一些事情：</p>
<ul>
<li>根据config传入的vm类型创建vm池</li>
<li>创建一个Reporter，这个东西的主要组件是一系列正则表达式，用于从vm输出中提取各种信息</li>
<li>从workdir中加载语料库（如果有的话）</li>
<li>启动一个HTTP Server，用于运行dashboard</li>
<li>启动RPC Server，用于和vm中的executor交互</li>
<li>进入Fuzz主循环</li>
</ul>
<h2 id="vm池"><a href="#vm池" class="headerlink" title="vm池"></a>vm池</h2><p>在RunManager的开头，创建了虚拟机池</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RunManager</span><span class="hljs-params">(mode *Mode, cfg *mgrconfig.Config)</span></span> &#123;<br>	<span class="hljs-keyword">var</span> vmPool *vm.Pool<br>		<span class="hljs-keyword">if</span> !cfg.VMLess &#123;<br>			<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>			vmPool, err = vm.Create(cfg, *flagDebug)<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				log.Fatalf(<span class="hljs-string">&quot;%v&quot;</span>, err)<br>			&#125;<br>			<span class="hljs-keyword">defer</span> vmPool.Close()<br>		&#125;<br>		...<br></code></pre></td></tr></table></figure>

<p>跟进<code>vm.Create</code>, flagDebug是从命令行参数<code>-debug</code> 解析而来，表示调试模式，在这个模式下只有vm池中将只有一个vm，且vm中同一时刻将只有一个进程在执行。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Create</span><span class="hljs-params">(cfg *mgrconfig.Config, debug <span class="hljs-type">bool</span>)</span></span> (*Pool, <span class="hljs-type">error</span>) &#123;<br>	typ, ok := vmimpl.Types[vmType(cfg.Type)]<br>	<span class="hljs-keyword">if</span> !ok &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;unknown instance type &#x27;%v&#x27;&quot;</span>, cfg.Type)<br>	&#125;<br>	env := &amp;vmimpl.Env&#123;<br>		Name:      cfg.Name,<br>		OS:        cfg.TargetOS,<br>		Arch:      cfg.TargetVMArch,<br>		Workdir:   cfg.Workdir,<br>		Image:     cfg.Image,<br>		SSHKey:    cfg.SSHKey,<br>		SSHUser:   cfg.SSHUser,<br>		Timeouts:  cfg.Timeouts,<br>		Snapshot:  cfg.Snapshot,<br>		Debug:     debug,<br>		Config:    cfg.VM,<br>		KernelSrc: cfg.KernelSrc,<br>	&#125;<br>	impl, err := typ.Ctor(env)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	count := impl.Count()<br>	<span class="hljs-keyword">if</span> debug &amp;&amp; count &gt; <span class="hljs-number">1</span> &#123;<br>		log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;limiting number of VMs from %v to 1 in debug mode&quot;</span>, count)<br>		count = <span class="hljs-number">1</span><br>	&#125;<br>	<span class="hljs-keyword">return</span> &amp;Pool&#123;<br>		impl:       impl,<br>		typ:        typ,<br>		workdir:    env.Workdir,<br>		template:   cfg.WorkdirTemplate,<br>		timeouts:   cfg.Timeouts,<br>		count:      count,<br>		snapshot:   cfg.Snapshot,<br>		hostFuzzer: cfg.SysTarget.HostFuzzer,<br>		statOutputReceived: stat.New(<span class="hljs-string">&quot;vm output&quot;</span>, <span class="hljs-string">&quot;Bytes of VM console output received&quot;</span>,<br>			stat.Graph(<span class="hljs-string">&quot;traffic&quot;</span>), stat.Rate&#123;&#125;, stat.FormatMB),<br>	&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>vmimpl.Types</code> 预置了一些Type，这些预置值在vm包下的其他文件中注册，例如<code>vm/qemu/qemu.go</code> :</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> _ vmimpl.Infoer = (*instance)(<span class="hljs-literal">nil</span>)<br>	vmimpl.Register(<span class="hljs-string">&quot;qemu&quot;</span>, vmimpl.Type&#123;<br>		Ctor:       ctor,<br>		Overcommit: <span class="hljs-literal">true</span>,<br>	&#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>Ctor</code>是Constructor，Type结构体包含了Ctor和两个布尔值，显然Ctor就是vm pool创建的核心逻辑，我们就只看qemu，别的vm不管了。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ctor</span><span class="hljs-params">(env *vmimpl.Env)</span></span> (vmimpl.Pool, <span class="hljs-type">error</span>) &#123;<br>	archConfig := archConfigs[env.OS+<span class="hljs-string">&quot;/&quot;</span>+env.Arch]<br>	cfg := &amp;Config&#123;<br>		Count:       <span class="hljs-number">1</span>,<br>		CPU:         <span class="hljs-number">1</span>,<br>		Mem:         <span class="hljs-number">1024</span>,<br>		ImageDevice: <span class="hljs-string">&quot;hda&quot;</span>,<br>		Qemu:        archConfig.Qemu,<br>		QemuArgs:    archConfig.QemuArgs,<br>		NetDev:      archConfig.NetDev,<br>		Snapshot:    <span class="hljs-literal">true</span>,<br>	&#125;<br>	...<br></code></pre></td></tr></table></figure>

<p>看一下<code>archConfigs[&quot;linux/amd64&quot;]</code> </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-string">&quot;linux/amd64&quot;</span>: &#123;<br>		Qemu:     <span class="hljs-string">&quot;qemu-system-x86_64&quot;</span>,<br>		QemuArgs: <span class="hljs-string">&quot;-enable-kvm -cpu host,migratable=off&quot;</span>,<br>		<span class="hljs-comment">// e1000e fails on recent Debian distros with:</span><br>		<span class="hljs-comment">// Initialization of device e1000e failed: failed to find romfile &quot;efi-e1000e.rom</span><br>		<span class="hljs-comment">// But other arches don&#x27;t use e1000e, e.g. arm64 uses virtio by default.</span><br>		NetDev: <span class="hljs-string">&quot;e1000&quot;</span>,<br>		RngDev: <span class="hljs-string">&quot;virtio-rng-pci&quot;</span>,<br>		CmdLine: []<span class="hljs-type">string</span>&#123;<br>			<span class="hljs-string">&quot;root=/dev/sda&quot;</span>,<br>			<span class="hljs-string">&quot;console=ttyS0&quot;</span>,<br>		&#125;,<br>	&#125;,<br></code></pre></td></tr></table></figure>

<p>这些都是用于创建qemu虚拟机的命令行参数，archConfigs用于构建默认Config，这里的Config是qemu包的Config，区别于manager使用的Config。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ctor</span><span class="hljs-params">(env *vmimpl.Env)</span></span> (vmimpl.Pool, <span class="hljs-type">error</span>) &#123;<br>...<br>	<span class="hljs-keyword">if</span> err := config.LoadData(env.Config, cfg); err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to parse qemu vm config: %w&quot;</span>, err)<br>		&#125;<br>...<br></code></pre></td></tr></table></figure>

<p>这里的env.Config的值从cfg.VM继承而来，这个字段是一个裸json :</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">VM json.RawMessage <span class="hljs-string">`json:&quot;vm&quot;`</span><br></code></pre></td></tr></table></figure>

<p>读到这里我们也能知道syzkaller config中的<code>vm</code>字段定义是依赖于vm类型（即config中的<code>type</code>字段）的。</p>
<p>再往后是一些基本的参数检查，检查结束后创建一个<code>vmimpl.Pool</code>结构体</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ctor</span><span class="hljs-params">(env *vmimpl.Env)</span></span> (vmimpl.Pool, <span class="hljs-type">error</span>) &#123;<br>...<br>	pool := &amp;Pool&#123;<br>		env:        env,<br>		cfg:        cfg,<br>		version:    version,<br>		target:     targets.Get(env.OS, env.Arch),<br>		archConfig: archConfig,<br>	&#125;<br>	<span class="hljs-keyword">return</span> pool, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>返回到<code>vm.Create</code>函数，这里的返回值赋给<code>impl</code> ，再套进<code>vm.Pool</code>结构体中，至此vm池创建结束。</p>
<h2 id="Corpus-Preload"><a href="#Corpus-Preload" class="headerlink" title="Corpus Preload"></a>Corpus Preload</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RunManager</span><span class="hljs-params">(mode *Mode, cfg *mgrconfig.Config)</span></span> &#123;<br>...<br>	mgr.initStats() <span class="hljs-comment">// 初始化各种统计指标</span><br>	<span class="hljs-keyword">if</span> mgr.mode.LoadCorpus &#123;<br>		<span class="hljs-keyword">go</span> mgr.preloadCorpus()<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-built_in">close</span>(mgr.corpusPreload)<br>	&#125;<br>...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里进行了语料库的载入，条件是<code>mgr.mode.LoadCorpus</code> 为true，只有<code>ModeFuzzing</code> ，<code>ModeCorpusTriage</code> ，<code>ModeCorpusRun</code> 三种模式满足。</p>
<p>跟进<code>preloadCorpus</code> 方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> preloadCorpus() &#123;<br>	info, err := manager.LoadSeeds(mgr.cfg, <span class="hljs-literal">false</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;failed to load corpus: %v&quot;</span>, err)<br>	&#125;<br>	mgr.fresh = info.Fresh<br>	mgr.corpusDB = info.CorpusDB<br>	mgr.corpusPreload &lt;- info.Candidates<br>&#125;<br></code></pre></td></tr></table></figure>

<p>LoadSeeds:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadSeeds</span><span class="hljs-params">(cfg *mgrconfig.Config, immutable <span class="hljs-type">bool</span>)</span></span> (Seeds, <span class="hljs-type">error</span>) &#123;<br>...<br>info.CorpusDB, err = db.Open(filepath.Join(cfg.Workdir, <span class="hljs-string">&quot;corpus.db&quot;</span>), !immutable)<br>...<br></code></pre></td></tr></table></figure>

<p>注意到immutable这个参数，其字面意思是不可变。</p>
<p>全局搜索LoadSeeds的引用就能发现只有两处进行了调用，一次是这里，进入fuzz loop前，传入false；另一处在<code>pkg/manager/diff.go#RunDiffFuzzer</code>，传入的是true，向上追踪，只有两处调用了这个方法，分别是<code>tools/syz-diff/diff.go#main</code>,<code>syz-cluster/workflow/fuzz-step/main.go#run</code>。都不是syz-manager会经过的路径，我们暂且不看。</p>
<p>接着看db.Open，syzkaller的db是一个自己实现的键值对数据库，这个函数负责将workdir中的corpus.db文件加载到<code>db.DB</code>结构体中，repair&#x3D;true</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Open opens the specified database file.</span><br><span class="hljs-comment">// If the database is corrupted and reading failed, then it returns an non-nil db</span><br><span class="hljs-comment">// with whatever records were recovered and a non-nil error at the same time.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Open</span><span class="hljs-params">(filename <span class="hljs-type">string</span>, repair <span class="hljs-type">bool</span>)</span></span> (*DB, <span class="hljs-type">error</span>) &#123;<br>	db := &amp;DB&#123;<br>		filename: filename,<br>	&#125;<br>	<span class="hljs-keyword">var</span> deserializeErr <span class="hljs-type">error</span><br>	db.Version, db.Records, db.uncompacted, deserializeErr = deserializeFile(db.filename)<br>	<span class="hljs-comment">// Deserialization error is considered a &quot;soft&quot; error if repair == true,</span><br>	<span class="hljs-comment">// but compact below ensures that the file is at least writable.</span><br>	<span class="hljs-keyword">if</span> deserializeErr != <span class="hljs-literal">nil</span> &amp;&amp; !repair &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, deserializeErr<br>	&#125;<br>	<span class="hljs-keyword">if</span> err := db.compact(); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	<span class="hljs-keyword">return</span> db, deserializeErr<br>&#125;<br></code></pre></td></tr></table></figure>

<p>desrialize的具体细节不重要，注意到这里对反序列化错误的处理：当读取失败且repair为true时，基于已经读取到的键值对进行文件格式恢复，即重新序列化，这样就可以应对语料库文件尾破损的情况。</p>
<p>回到<code>LoadSeeds</code> 里，返回值保存到<code>info.corpusDB</code> ，这里面的键值对(Record)是byte[]形式，还需要将字节流还原为种子(Seed)，我们已经解释过，种子实质是fuzz过程中产生的有价值的输入程序（syscall序列），在syzkaller的源码中对应结构体<code>prog.Prog</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadSeeds</span><span class="hljs-params">(cfg *mgrconfig.Config, immutable <span class="hljs-type">bool</span>)</span></span> (Seeds, <span class="hljs-type">error</span>) &#123;<br>	...<br>	outputs := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *input, <span class="hljs-number">32</span>)<br> 	chErr := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">error</span>, <span class="hljs-number">1</span>)<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		chErr &lt;- readInputs(cfg, info.CorpusDB, outputs)<br>		<span class="hljs-built_in">close</span>(outputs)<br>	&#125;()<br>	...<br></code></pre></td></tr></table></figure>

<p>看一眼<code>readInputs</code> </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">readInputs</span><span class="hljs-params">(cfg *mgrconfig.Config, db *db.DB, output <span class="hljs-keyword">chan</span> *input)</span></span> <span class="hljs-type">error</span> &#123;<br>	procs := runtime.GOMAXPROCS(<span class="hljs-number">0</span>)<br>	inputs := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *input, procs)<br>	<span class="hljs-keyword">var</span> wg sync.WaitGroup<br>	wg.Add(procs)<br><br>	<span class="hljs-keyword">defer</span> wg.Wait()<br>	<span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(inputs)<br>	<span class="hljs-keyword">for</span> p := <span class="hljs-number">0</span>; p &lt; procs; p++ &#123;<br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>			<span class="hljs-keyword">defer</span> wg.Done()<br>			<span class="hljs-keyword">for</span> inp := <span class="hljs-keyword">range</span> inputs &#123;<br>				inp.Prog, inp.Err = ParseSeed(cfg.Target, inp.Data)<br>				output &lt;- inp<br>			&#125;<br>		&#125;()<br>	&#125;<br><br>	<span class="hljs-keyword">for</span> key, rec := <span class="hljs-keyword">range</span> db.Records &#123;<br>		inputs &lt;- &amp;input&#123;<br>			Key:  key,<br>			Data: rec.Val,<br>		&#125;<br>	&#125;<br>	seedPath := filepath.Join(<span class="hljs-string">&quot;sys&quot;</span>, cfg.TargetOS, <span class="hljs-string">&quot;test&quot;</span>)<br>	seedDir := filepath.Join(cfg.Syzkaller, seedPath)<br>	<span class="hljs-keyword">if</span> osutil.IsExist(seedDir) &#123;<br>		seeds, err := os.ReadDir(seedDir)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;failed to read seeds dir: %w&quot;</span>, err)<br>		&#125;<br>		<span class="hljs-keyword">for</span> _, seed := <span class="hljs-keyword">range</span> seeds &#123;<br>			data, err := os.ReadFile(filepath.Join(seedDir, seed.Name()))<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;failed to read seed %v: %w&quot;</span>, seed.Name(), err)<br>			&#125;<br>			inputs &lt;- &amp;input&#123;<br>				IsSeed: <span class="hljs-literal">true</span>,<br>				Path:   filepath.Join(seedPath, seed.Name()),<br>				Data:   data,<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>syzkaller会从两个地方加载种子，一个是workdir下的corpus.db，一个是syzkaller源码目录下的<code>sys/&#123;os&#125;/test</code> ，如果后者加载失败，那么LoadSeeds将直接返回一个空集合。这里种子的加载是一个生产-消费模式的写法，procs是可用处理器数量，inputs是缓冲长度为procs的输入通道，同时procs个goroutine负责从inputs中读取和解析数据，解析结果输入到output这个channel中。</p>
<p>再回到LoadSeeds中，我们会发现对outputs的处理也是一个异步结构，readInputs是用goroutine启动的，下面的for循环等待从outputs中接收数据，将有效种子加入candidates，candidates是fuzz的初始输入，在执行这些初始输入的基础上去做变异等一系列后续操作。</p>
<p>这里对“有效”的定义是<code>inp.Prog</code> 是否为nil，即<strong>如果从原始数据中还原出了一个当前fuzz目标可执行的syscall序列，那么就认为种子有效。</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadSeeds</span><span class="hljs-params">(cfg *mgrconfig.Config, immutable <span class="hljs-type">bool</span>)</span></span> (Seeds, <span class="hljs-type">error</span>) &#123;<br>...<br> 	<span class="hljs-keyword">for</span> inp := <span class="hljs-keyword">range</span> outputs &#123;<br>		<span class="hljs-keyword">if</span> inp.Prog == <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">if</span> inp.IsSeed &#123;<br>				<span class="hljs-keyword">if</span> errors.Is(inp.Err, ErrSkippedTest) &#123;<br>					skippedSeeds++<br>					log.Logf(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;seed %s is skipped: %s&quot;</span>, inp.Path, inp.Err)<br>				&#125; <span class="hljs-keyword">else</span> &#123;<br>					brokenSeeds++<br>					log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;seed %s is broken: %s&quot;</span>, inp.Path, inp.Err)<br>				&#125;<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				brokenCorpus = <span class="hljs-built_in">append</span>(brokenCorpus, inp.Key)<br>			&#125;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		flags := corpusFlags<br>		<span class="hljs-keyword">if</span> inp.IsSeed &#123;<br>			<span class="hljs-keyword">if</span> _, ok := info.CorpusDB.Records[hash.String(inp.Prog.Serialize())]; ok &#123;<br>				<span class="hljs-keyword">continue</span><br>			&#125;<br>			<span class="hljs-comment">// Seeds are not considered &quot;from corpus&quot; (won&#x27;t be rerun multiple times)</span><br>			<span class="hljs-comment">// b/c they are tried on every start anyway.</span><br>			flags = fuzzer.ProgMinimized<br>		&#125;<br>		candidates = <span class="hljs-built_in">append</span>(candidates, fuzzer.Candidate&#123;<br>			Prog:  inp.Prog,<br>			Flags: flags,<br>		&#125;)<br>	&#125;<br>	...<br></code></pre></td></tr></table></figure>

<p>观察到candidates保存了Prog和Flags两个变量，后者用于标识此程序的类型，其默认来源于<code>corpusFlags := versionToFlags(info.CorpusDB.Version)</code> ，整个语料库的统一标识；当一个有效种子不在<code>info.CorpusDB.Records</code> 中，即由<code>sys/&#123;os&#125;/test</code> 目录加载而来时，设置标志为<code>ProgMinimized</code> ，字面上就是“已经最小化的”，关于最小化这个事情我们放到后面再解释。</p>
<p>总之，被预加载的语料最终在<code>preloadCorpus</code>的结尾会被输送到<code>mgr</code>，我们注意到这是贯穿fuzz始终的最高层全局变量。</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>本文从 syz-manager 的入口函数出发，详细梳理了 syzkaller 在启动阶段的若干关键步骤：加载配置文件、创建虚拟机池，并开始载入已有的语料库（corpus）。<br>下一篇文章，我们将接着审计RunManager函数，深入RPC Server的构建和启动细节。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/fuzz/" class="category-chain-item">fuzz</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/code-review/" class="print-no-link">#code review</a>
      
        <a href="/tags/go/" class="print-no-link">#go</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/04/04/syzkaller%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-0-Run-Read-doc/" title="[syzkaller源码阅读] 0. Run &amp; Read doc">
                        <span class="hidden-mobile">[syzkaller源码阅读] 0. Run &amp; Read doc</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"ec6f52ffea297b5c1479","clientSecret":"7fb4cc3a532416bea3ba78f2b66835d542ab0a9f","repo":"gitalk_storage","owner":"pikaball","admin":["pikaball"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: 'f015d8341cd63b7e6be1d802de2b3b4f'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
